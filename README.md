# AzerothCore Rebuild/Update Script

This script is designed to help you **update**, **build**, **run**, and **manage** your **AzerothCore** server â€” a popular server emulator for **World of Warcraft**. It simplifies common tasks such as updating the source code, managing dependencies, rebuilding the server, handling server processes, managing backups, viewing logs, and configuring operational parameters via an external file.

The script is now highly modular and supports both traditional and **Docker-based** AzerothCore setups.

---

## Features:
- **Docker Support**: Automatically detects if your AzerothCore installation is managed by Docker and adapts its functionality to use `docker compose` for server management, backups, and logging.
- **Modular and Maintainable Code**: The script is now broken down into a `lib/` directory with multiple files, making it easier to maintain, debug, and contribute to.
- **Expanded Dependency Check**: Automatically checks for essential software and supports multiple package managers, including `apt` (Debian/Ubuntu), `yum` (CentOS/RHEL), `pacman` (Arch Linux), and `brew` (macOS).
- **Flexible Editor Choice**: Respects your `$EDITOR` environment variable for editing configuration files, falling back to `nano`, `vi`, or `ed` if it's not set.
- **Source Code Update**: Allows you to update your existing AzerothCore server's source code from its Git repository.
- **Rebuilding the Server**: Uses `cmake` and `make` to rebuild and reinstall the updated AzerothCore server, with an option to specify the number of CPU cores for faster builds.
- **Safety Check**: Prompts the user to stop running servers before a rebuild operation to prevent conflicts and ensure a clean build process.
- **Process Management**: Advanced control over server processes, including starting, stopping,restarting, and checking the status of `authserver` and `worldserver` within their TMUX session (for traditional setups) or Docker containers.
- **Backup and Restore**: Easily backup your server's databases (world, characters, auth) and server configuration files (`worldserver.conf`, `authserver.conf`). Restore from existing backups.
- **Backup Dry Run**: A "Dry Run" option for backups allows you to see what the backup process will do without actually performing it.
- **Log Viewer**: View script operation logs, as well as live (`tail -f`) or static (`less`) `authserver` and `worldserver` logs directly through the script.
- **Module Management**: Helps you to update all or individual custom modules located in your `modules` directory.
- **External Configuration**: Persistent settings via an external configuration file (`~/.ACrebuild/ACrebuild.conf`), making it easy to customize paths, credentials (with caution for passwords), and other operational parameters.
- **Flexible Menu System**: Interactive menus guide you through various operations.
- **Self-Update Capability**: The script can update itself to the latest version from its Git repository.

---

## Installation

1.  **Clone the repository** (or download the script) to your local machine:
    ```bash
    git clone https://github.com/Stuntmonkey4u/ACrebuild.git
    cd ACrebuild
    chmod +x ACrebuild.sh
    ```
2.  **Run the script**:
    ```bash
    ./ACrebuild.sh
    ```
    The script will guide you through initial setup, including the location of your AzerothCore installation if it's not in the default path (`~/azerothcore`).

---

## How It Works

When you run `ACrebuild.sh`, it presents an interactive main menu with several categories:

-   **Server Operations**: Options to update source code, manage custom modules, and perform server rebuilds (with an option to also run the server post-rebuild). Server starting is also handled under "Process Management".
-   **Server Management**:
    -   **Process Management**: Control starting, stopping, and restarting `authserver` and `worldserver`. Check their status.
    -   **Backup/Restore Options**: Create new backups of your databases and server configurations, or restore from a previously created backup. Includes a "Dry Run" option.
    -   **Log Viewer**: Access and view logs generated by the script itself, `authserver`, or `worldserver`.
-   **Script Maintenance & Exit**:
    -   **Self-Update ACrebuild Script**: If the script was cloned from its Git repository, this option allows it to fetch and apply the latest updates to itself.
    -   **Configuration Options**: Manage the script's settings. You can view the current configuration, edit the configuration file directly, or reset all settings to their defaults.
    -   **Quit Script**: Exits the `ACrebuild.sh` script.

### Docker Support

The script automatically detects if your `AZEROTHCORE_DIR` contains a `docker-compose.yml` file. If it does, the script enters "Docker Mode" and adapts its functionality:
-   **Server Management**: Instead of using TMUX, the script uses `docker compose` to start, stop, and restart the `ac-worldserver` and `ac-authserver` services.
-   **Backups**: Database backups are performed by executing `mysqldump` inside the `ac-db` container.
-   **Log Viewing**: Logs are viewed using `docker compose logs`.

This allows you to manage both traditional and Docker-based AzerothCore installations with the same script and interface.

### Code Structure

The script has been refactored for better maintainability. The core logic is now located in the `lib/` directory, with each file responsible for a specific feature:
-   `core.sh`: Core functions, shared variables, and error handling.
-   `config.sh`: Configuration management.
-   `dependencies.sh`: Dependency checking.
-   `update.sh`: Script and module updating.
-   `server.sh`: Server process management.
-   `backup.sh`: Backup and restore functionality.
-   `logging.sh`: Log viewing.
-   `ui.sh`: All user interface elements (menus, messages).

The main `ACrebuild.sh` script is now primarily an entry point that sources these libraries and runs the main application loop.

---

## Configuration

The `ACrebuild.sh` script uses an external configuration file located at:
`~/.ACrebuild/ACrebuild.conf`

This file is automatically created with default values when you first run the script or if it's missing. You can manage this configuration through the **"Configuration Options"** menu within the script.

Key settings you can configure include:

-   `AZEROTHCORE_DIR`: The path to your AzerothCore installation.
-   `BACKUP_DIR`: The directory where backups will be stored.
-   `DB_USER`, `DB_PASS` (use with caution, leave empty to be prompted), `AUTH_DB_NAME`, `CHAR_DB_NAME`, `WORLD_DB_NAME`: Database connection details for backups and restores.
-   Paths for server configuration and log directories (usually relative to `AZEROTHCORE_DIR`).
-   Filenames for server and script logs.
-   `CORES_FOR_BUILD`: Number of CPU cores to use during the `make` process for faster compilation.

It's recommended to manage these settings via the script's menu, especially for paths, to ensure they are correctly formatted. For sensitive information like `DB_PASS`, the script will always prompt you if it's empty in the configuration file, which is the recommended approach for security.

---

## License

This script is licensed under the **MIT License**. Feel free to modify and use it as needed.

---

## Disclaimer

This script is provided as-is, with no warranties or guarantees. Use at your own risk. Make sure to backup your server data before running any script that modifies or updates your environment.

---

## Contributors (So Far...)

Created by Stuntmonkey4u

## Pull Request

If you have an improvement or idea, make a pull request, get your name added to the Contributors list!!
